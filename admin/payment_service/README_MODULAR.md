# Модульная структура Payment Service

## Обзор

Код платежного сервиса теперь разбит на отдельные модули для легкой оптимизации и поддержки.

## Структура файлов

```
admin/payment_service/
├── payment_service.py          # Основной сервис (МОДУЛЬНАЯ ВЕРСИЯ)
├── payment_service_old_backup.py  # Старая монолитная версия (бэкап)
├── steps/                      # Модули для каждого этапа
│   ├── __init__.py            # Экспорты модулей
│   ├── form_helpers.py        # Вспомогательные функции для форм
│   ├── step1_amount.py        # Этап 1: Ввод суммы и выбор Uzcard
│   └── step2_form.py          # Этап 2: Заполнение формы
└── README_MODULAR.md          # Этот файл
```

## Модули

### `payment_service.py` (Основной файл)
- Класс `PaymentService` - управление браузером
- Метод `create_payment_link()` - координирует этапы
- Использует модули из `steps/` вместо монолитного кода

### `steps/step1_amount.py`
**Функция:** `process_step1(page, amount, log_func)`

**Что делает:**
- Вводит сумму платежа
- Ждет расчета комиссии
- Выбирает "Способ перевода" → Uzcard
- Активирует кнопку "Продолжить"
- Переходит на страницу sender-details

**Оптимизации:**
- Retry логика для ввода суммы (до 10 попыток)
- Retry для выбора Uzcard (до 5 попыток)
- Умная активация кнопки (до 25 попыток с повторным вводом)

**Время:** ~3-5 секунд

### `steps/step2_form.py`
**Функция:** `process_step2(page, card_number, owner_name, sender_data, log_func)`

**Что делает:**
- Заполняет поля отправителя (паспорт, ФИО, даты, телефон, адреса)
- Выбирает страны рождения и регистрации
- Заполняет реквизиты получателя (карта, имя, фамилия)
- Прокликивает все поля для валидации
- Нажимает кнопку "Продолжить"

**Оптимизации (текущие):**
- Задержки между полями: 300-600мс (было 500-1200мс)
- Стабильная валидация дат: 800мс × 2 (двойная проверка)
- Пауза перед получателем: 400мс (было 700мс)
- Убраны лишние движения мыши

**Время:** ~26-27 секунд (было ~30.8с)

### `steps/form_helpers.py`
**Вспомогательные функции:**

- `fill_react_input()` - Заполнение React controlled inputs
  - Для дат: посимвольный ввод (стабильно)
  - Для обычных полей: JavaScript подход
  
- `fill_field_simple()` - Обертка для простого заполнения

- `select_country_async()` - Выбор страны из выпадающего списка
  - До 3 попыток
  - Проверка правильного выбора

## Как оптимизировать

### Пример 1: Уменьшить задержки в Step 2

Откройте `steps/step2_form.py` и измените задержки:

```python
# Было:
await page.wait_for_timeout(random.randint(300, 500))

# Стало (быстрее, но менее стабильно):
await page.wait_for_timeout(random.randint(200, 400))
```

### Пример 2: Изменить логику валидации дат

Откройте `steps/form_helpers.py` и измените `fill_react_input()`:

```python
if is_date_field:
    # Ваша новая логика для дат
    pass
```

### Пример 3: Добавить новый этап

1. Создайте `steps/step3_captcha.py`
2. Добавьте функцию `process_step3(page, log_func)`
3. Импортируйте в `steps/__init__.py`
4. Вызовите в `payment_service.py` после step2

## Преимущества модульной структуры

✅ **Легкая оптимизация** - изменяйте только нужный этап
✅ **Читаемость** - каждый файл отвечает за свою задачу
✅ **Тестирование** - можно тестировать этапы отдельно
✅ **Переиспользование** - функции из form_helpers можно использовать везде
✅ **Git diff** - изменения видны четко по файлам

## Текущие результаты

- **Этап 1:** ~3-5 секунд
- **Этап 2:** ~26-27 секунд
- **Общее время:** ~30-32 секунды
- **Стабильность:** Очень высокая (оптимизированные задержки + двойная проверка дат)

## Откат на старую версию

Если нужно вернуться к монолитной версии:

```bash
cp admin/payment_service/payment_service_old_backup.py admin/payment_service/payment_service.py
```

## Тестирование

```bash
# Тест модульной версии
python admin/payment_service/payment_service.py

# Тест конкретного этапа (пример)
python -c "from steps.step1_amount import process_step1; ..."
```
