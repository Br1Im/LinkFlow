# Модульная структура Payment Service

## Обзор

Код платежного сервиса разбит на 3 этапа для легкой оптимизации.

## Структура файлов

```
admin/payment_service/
├── payment_service.py          # Основной сервис (437 строк)
├── steps/                      # Модули для каждого этапа
│   ├── __init__.py            # Экспорты
│   ├── form_helpers.py        # Вспомогательные функции
│   ├── step1_amount.py        # Этап 1: Ввод суммы (~200 строк)
│   ├── step2_form.py          # Этап 2: Заполнение формы (~150 строк)
│   └── step3_modal_captcha.py # Этап 3: Модалка и капча (~150 строк)
└── README_MODULAR.md          # Документация
```

## Этапы

### Этап 1: Ввод суммы (step1_amount.py)
**Время:** ~4-5 секунд

**Что делает:**
- Вводит сумму платежа
- Ждет расчета комиссии
- Выбирает Uzcard
- Активирует кнопку "Продолжить"

### Этап 2: Заполнение формы (step2_form.py)
**Время:** ~12-13 секунд

**Что делает:**
- Заполняет данные отправителя (паспорт, ФИО, даты)
- Заполняет реквизиты получателя (карта, имя)
- Валидирует все поля

**Оптимизации:**
- Задержки: 300-600мс (было 500-1200мс)
- Стабильная валидация дат: 800мс × 2

### Этап 3: Модалка и капча (step3_modal_captcha.py)
**Время:** ~3 секунды

**Что делает:**
- Решает капчу (если есть)
- Обрабатывает модалку "Проверка данных"
- Нажимает "Продолжить"

## Общее время

- **Этап 1:** ~4.3с
- **Этап 2:** ~12.3с
- **Этап 3:** ~3.0с
- **ИТОГО:** ~19.6с (без ожидания QR)

## Как оптимизировать

### Уменьшить задержки в Step 2

Откройте `steps/step2_form.py`:

```python
# Было:
await page.wait_for_timeout(random.randint(300, 500))

# Стало (быстрее):
await page.wait_for_timeout(random.randint(200, 400))
```

### Изменить логику капчи

Откройте `steps/step3_modal_captcha.py` и измените логику решения.

## Преимущества

✅ **Чистый код** - 437 строк вместо 1965  
✅ **Модульность** - каждый этап в отдельном файле  
✅ **Легкая оптимизация** - изменяйте только нужный этап  
✅ **Читаемость** - понятная структура  

## Удалено

❌ `payment_service_modular.py` - дубликат  
❌ `payment_service_old_backup.py` - старая версия (в git если нужна)  
❌ `src/sender_data.py` - старый способ загрузки (теперь из БД)
